(function(){function n(c){(function(a){var k,c,I,J,p;function x(){a("object.cgmp-json-string-placeholder").each(function(o,d){var b=a(d).attr("id"),b=a(d).find("param#json-string-"+b).val(),b=m.searchReplace(b,"'",""),b=b.replace("&quot;",""),b=y(b);if("undefined"==typeof b||!b)return h.fatal("We did not parse JSON from OBJECT param. Aborting map generation .."),!1;if(0<a("div#"+b.id).length){var c=new google.maps.Map(document.getElementById(b.id));n.initMap(c,b.bubbleautopan,parseInt(b.zoom),b.maptype);
q.init(c);var g=new w;g.init(c,b.bubbleautopan);n.setMapControls({mapTypeControl:"true"===b.maptypecontrol,panControl:"true"===b.pancontrol,zoomControl:"true"===b.zoomcontrol,scaleControl:"true"===b.scalecontrol,scrollwheel:"true"===b.scrollwheelcontrol,streetViewControl:"true"===b.streetviewcontrol,tilt:"true"===b.tiltfourtyfive?45:null,draggable:"true"===b.draggable,overviewMapControl:!0,overviewMapControlOptions:{opened:!1}});"true"===b.showpanoramio&&q.buildPanoramioLayer(b.panoramiouid);"true"===
b.showbike&&q.buildBikeLayer();"true"===b.showtraffic&&q.buildTrafficLayer();null!=b.kml&&""!=m.trim(b.kml)?q.buildKmlLayer(b.kml):(null!=b.markerlist&&""!=m.trim(b.markerlist)&&g.buildAddressMarkers(b.markerlist,b.addmarkermashup,b.addmarkermashupbubble),g.isBuildAddressMarkersCalled()||E.alertError(k.msgMissingMarkers))}else h.fatal("It looks like the map DIV placeholder ID ["+b.id+"] does not exist in the page!")})}var y=function(){h.fatal("Using parseJson stub..")};1.4<=parseFloat(a.fn.jquery)?
y=a.parseJSON:window.JSON&&window.JSON.parse&&(y=window.JSON.parse);k=void 0;c=void 0;I=void 0;J=void 0;p=void 0;var n=function(){var a={};return{initMap:function(d,b,c,g){a=d;var d=[],h;for(h in google.maps.MapTypeId)d.push(google.maps.MapTypeId[h]);"OSM"==g?(d.push(g),a.mapTypes.set(g,new google.maps.ImageMapType({getTileUrl:function(a,b){return"http://tile.openstreetmap.org/"+b+"/"+a.x+"/"+a.y+".png"},tileSize:new google.maps.Size(256,256),name:"OpenStreet",maxZoom:20}))):"ROADMAP"==g?g=google.maps.MapTypeId.ROADMAP:
"SATELLITE"==g?g=google.maps.MapTypeId.SATELLITE:"HYBRID"==g?g=google.maps.MapTypeId.HYBRID:"TERRAIN"==g&&(g=google.maps.MapTypeId.TERRAIN);a.setOptions({zoom:c,mapTypeId:g,mapTypeControlOptions:{mapTypeIds:d}})},setMapControls:function(d){a.setOptions(d)}}}(),q=function(){var a={};return{init:function(d){a=d},buildKmlLayer:function(d){if(0>d.toLowerCase().indexOf("http"))return h.error("KML URL must start with HTTP(S). Aborting.."),!1;var b=new google.maps.KmlLayer(d);google.maps.event.addListener(b,
"status_changed",function(){var a=b.getStatus();if(a!=google.maps.KmlLayerStatus.OK){var d="";switch(a){case google.maps.KmlLayerStatus.DOCUMENT_NOT_FOUND:d=k.kmlNotFound;break;case google.maps.KmlLayerStatus.DOCUMENT_TOO_LARGE:d=k.kmlTooLarge;break;case google.maps.KmlLayerStatus.FETCH_ERROR:d=k.kmlFetchError;break;case google.maps.KmlLayerStatus.INVALID_DOCUMENT:d=k.kmlDocInvalid;break;case google.maps.KmlLayerStatus.INVALID_REQUEST:d=k.kmlRequestInvalid;break;case google.maps.KmlLayerStatus.LIMITS_EXCEEDED:d=
k.kmlLimits;break;case google.maps.KmlLayerStatus.TIMED_OUT:d=k.kmlTimedOut;break;case google.maps.KmlLayerStatus.UNKNOWN:d=k.kmlUnknown}if(""!=d){var c=k.kml.replace("[MSG]",d),c=c.replace("[STATUS]",a);E.alertError(c);h.error("Google returned KML error: "+d+" ("+a+")");h.error("KML file: "+b.getUrl())}}});b.setMap(a)},buildTrafficLayer:function(){(new google.maps.TrafficLayer).setMap(a)},buildBikeLayer:function(){(new google.maps.BicyclingLayer).setMap(a)},buildPanoramioLayer:function(d){if("undefined"==
typeof google.maps.panoramio||!google.maps.panoramio||null==google.maps.panoramio)return h.error("We cannot access Panoramio library. Aborting.."),!1;var b=new google.maps.panoramio.PanoramioLayer;b?(null!=d&&""!=d&&b.setUserId(d),b.setMap(a)):h.error("Could not instantiate Panoramio object. Aborting..")}}}(),w=function(){function o(){null!=r?l.getCenter()!=r.getCenter()&&(h.info("Panning map back to its original bounds center: "+r.getCenter()),l.fitBounds(r),l.setCenter(r.getCenter())):null!=F&&
(h.info("Panning map back to its original center: "+F+" and updated zoom: "+K),l.setCenter(F),l.setZoom(K))}function d(e){a(e+" input#a_address").val("");a(e+" input#b_address").val("");a(e+" input#a_address").removeClass("d_error");a(e+" input#b_address").removeClass("d_error")}function b(e,j){var i=W(e.content,j),f="div#direction-controls-placeholder-"+s,b=a("div#rendered-directions-placeholder-"+s);google.maps.event.addListener(e,"click",function(){d(f);a(f).fadeOut();z.setMap(null);b.html("");
b.hide();a(f+" button#print_sub").hide();t.setContent(i.bubbleContent);t.setOptions({disableAutoPan:"true"==P?!1:!0});t.open(l,this)});g(e,i,f);U(e,i,f,b)}function U(e,j,i,f){var b="div#bubble-"+j.bubbleHolderId,c=e.content,c=c.replace("Lat/Long: ","");a(b+" a.dirToHereTrigger").live("click",function(){this.id=="toHere-"+j.bubbleHolderId&&(a(i).fadeIn(),a(i+" input#a_address").val(""),a(i+" input#b_address").val(c),a(i+" input#radio_miles").attr("checked","checked"))});a(b+" a.dirFromHereTrigger").live("click",
function(){this.id=="fromHere-"+j.bubbleHolderId&&(a(i).fadeIn(),a(i+" input#a_address").val(c),a(i+" input#b_address").val(""),a(i+" input#radio_miles").attr("checked","checked"))});a(i+" div.d_close-wrapper").live("click",function(){d(i);a(this).parent().fadeOut();z.setMap(null);f.html("");f.hide();a(i+" button#print_sub").hide();o();return!1})}function g(e,j,i){Q.getPanoramaByLocation(e.position,50,function(f,b){b===google.maps.StreetViewStatus.OK?a("a#trigger-"+j.bubbleHolderId).live("click",
function(){var f={navigationControl:!0,enableCloseButton:!0,addressControl:!1,linksControl:!0,scrollwheel:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM},position:e.position,pov:{heading:165,pitch:0,zoom:1}},b=new google.maps.StreetViewPanorama(document.getElementById("bubble-"+j.bubbleHolderId),f);b.setVisible(!0);google.maps.event.addListener(t,"closeclick",function(){d(i);a(i).fadeOut();null!=b&&(b.unbind("position"),b.setVisible(!1));b=null});google.maps.event.addListener(b,
"closeclick",function(){null!=b&&(b.unbind("position"),b.setVisible(!1),a("div#bubble-"+j.bubbleHolderId).css("background","none"));b=null})}):(a("a#trigger-"+j.bubbleHolderId).live("click",function(a){a.preventDefault()}),a("a#trigger-"+j.bubbleHolderId).attr("style","text-decoration: none !important; color: #ddd !important"),google.maps.event.addListener(t,"domready",function(){a("a#trigger-"+j.bubbleHolderId).removeAttr("href");a("a#trigger-"+j.bubbleHolderId).attr("style","text-decoration: none !important; color: #ddd !important")}))})}
function V(){var e="div#direction-controls-placeholder-"+s,b=a("div#rendered-directions-placeholder-"+s);a(e+" a#reverse-btn").live("click",function(){var b=a(e+" input#a_address").val(),j=a(e+" input#b_address").val();a(e+" input#a_address").val(j);a(e+" input#b_address").val(b);return!1});a(e+" a#d_options_show").live("click",function(){a(e+" a#d_options_hide").show();a(e+" a#d_options_show").hide();a(e+" div#d_options").show();return!1});a(e+" a#d_options_hide").live("click",function(){a(e+" a#d_options_hide").hide();
a(e+" a#d_options_show").show();a(e+" div#d_options").hide();a(e+" input#avoid_hway").removeAttr("checked");a(e+" input#avoid_tolls").removeAttr("checked");a(e+" input#radio_km").removeAttr("checked");a(e+" input#radio_miles").attr("checked","checked");return!1});a(e+" button#d_sub").live("click",function(){var i=a(e+" input#a_address").val(),f=a(e+" input#b_address").val(),d=!1;if(null==i||""==i)a(e+" input#a_address").addClass("d_error"),d=!0;if(null==f||""==f)a(e+" input#b_address").addClass("d_error"),
d=!0;if(!d){a(e+" button#d_sub").attr("disabled","disabled").html("Please wait..");var c=google.maps.DirectionsTravelMode.DRIVING;a(e+" a#dir_w_btn").hasClass("selected")&&(c=google.maps.DirectionsTravelMode.WALKING);var d=a(e+" input#avoid_hway").is(":checked"),o=a(e+" input#avoid_tolls").is(":checked"),g=a(e+" input#radio_miles").is(":checked"),c={origin:i,destination:f,travelMode:c,provideRouteAlternatives:!0};d&&(c.avoidHighways=!0);o&&(c.avoidTolls=!0);c.unitSystem=g?google.maps.DirectionsUnitSystem.IMPERIAL:
google.maps.DirectionsUnitSystem.METRIC;R.route(c,function(d,c){c==google.maps.DirectionsStatus.OK?(b.html(""),b.show(),z.setMap(l),z.setDirections(d),a(e+" button#d_sub").removeAttr("disabled").html("Get directions"),a(e+" button#print_sub").fadeIn(),t.close()):(h.error('Could not route directions from "'+i+'" to "'+f+'", got result from Google: '+c),b.html("<span style='font-size: 12px; font-weight: bold; color: red'>Could not route directions from<br />'"+i+"' to<br />'"+f+"'<br />Got result from Google: ["+
c+"]</span>"),a(e+" button#print_sub").hide(),a(e+" button#d_sub").removeAttr("disabled").html("Get directions"))})}});a(e+" button#print_sub").live("click",function(){var b=a(e+" input#a_address").val(),j=a(e+" input#b_address").val(),d="d";a(e+" a#dir_w_btn").hasClass("selected")&&(d="w");b="http://maps.google.com/?saddr="+b+"&daddr="+j+"&dirflg="+d+"&pw=2";a(e+" input#radio_miles").is(":checked")&&(b+="&doflg=ptm");window.open(b);return!1});a(e+" input#a_address").live("change focus",function(){a(e+
" input#a_address").removeClass("d_error");return!1});a(e+" input#b_address").live("change focus",function(){a(e+" input#b_address").removeClass("d_error");return!1});a(e+" .kd-button").live("click",function(){var b=this.id;"dir_d_btn"==b?a(e+" a#dir_d_btn").hasClass("selected")?h.warn("Driving travel mode is already selected"):(a(e+" a#dir_d_btn").addClass("selected"),a(e+" a#dir_w_btn").removeClass("selected")):"dir_w_btn"==b&&(a(e+" a#dir_w_btn").hasClass("selected")?h.warn("Walking travel mode is already selected"):
(a(e+" a#dir_w_btn").addClass("selected"),a(e+" a#dir_d_btn").removeClass("selected")));return!1})}function W(a,b){var i=Math.floor(111111*Math.random()),i=i+"-"+s,f="<div id='bubble-"+i+"' style='height: 130px !important; width: 300px !important;' class='bubble-content'>";if(b.geoMashup)var d=b.postTitle.substring(0,30),f=f+""+("<p class='geo-mashup-post-title'><a title='Original post: "+b.postTitle+"' href='"+b.postLink+"'>"+d+"..</a></p>"),f=f+("<p class='geo-mashup-post-excerpt'>"+b.postExcerpt+
"</p>");else f+="<h4>"+c.address+":</h4>",f+="<p class='custom-bubble-text'>"+a+"</p>",""!=b.customBubbleText&&(f+="<p class='custom-bubble-text'>"+b.customBubbleText+"</p>");f=f+"<hr />"+("<p class='custom-bubble-text'>"+c.directions+": <a id='toHere-"+i+"' class='dirToHereTrigger' href='javascript:void(0);'>"+c.toHere+"</a> - <a id='fromHere-"+i+"' class='dirFromHereTrigger' href='javascript:void(0);'>"+c.fromHere+"</a> | <a id='trigger-"+i+"' class='streetViewTrigger' href='javascript:void(0);'>"+
c.streetView+"</a></p>");return{bubbleHolderId:i,bubbleContent:f+"</div>"}}function O(b,j){var d=1;a.each(b,function(){null==this.excerpt&&(this.excerpt="");var a=this.addy.split(I);m.isNumeric(a[0])?p(d,a,this.title,this.permalink,this.excerpt,j):m.isAlphaNumeric(a[0])?n(d,a,this.title,this.permalink,this.excerpt,j):(n(d,a,this.title,this.permalink,this.excerpt,j),h.warn("Unknown type of geo destination in regexp: "+a[0]+", fallingback to store it as an address"));d++});h.info("Have "+(d-1)+" destinations for marker Geo mashup..")}
function n(a,b,d,f,c,h){null!=b[2]?-1!=b[2].indexOf("No description provided")&&(b[2]=""):b[2]="";A.push({address:b[0],animation:google.maps.Animation.DROP,zIndex:a,markerIcon:b[1],customBubbleText:b[2],postTitle:d,postLink:f,postExcerpt:c,geoMashup:h})}function p(a,b,d,f,c,o){var g=[];-1!=b[0].indexOf(",")?g=b[0].split(","):-1!=b[0].indexOf(";")&&(g=b[0].split(";"));if(0==g.length)return h.warn("Exploded lat/long array has length of zero"),!1;g[0]=m.trim(g[0]);g[1]=m.trim(g[1]);if(""==g[0]||""==
g[1])return h.warn("Lat or Long are empty string"),!1;b[0]=new google.maps.LatLng(parseFloat(g[0]),parseFloat(g[1]));n(a,b,d,f,c,o)}function B(){clearTimeout(G);if(0<A.length){var b=A.shift();h.info("Passing ["+b.address+"] to Geo service. Have left "+A.length+" items to process!");b.address instanceof google.maps.LatLng?v(b):S.geocode({address:b.address},function(a,d){x(a,d,b)})}else{q();if(0<H.length){var d="";a.each(H,function(a,b){d+="&nbsp;&nbsp;&nbsp;<b>"+(1+a)+". "+b+"</b><br />"});E.alertError(k.badAddresses.replace("[REPLACE]",
d))}H=[]}}function q(){1<u.length?(a.each(u,function(a,b){C.contains(b.position)||C.extend(b.position)}),r=C,null!=C&&l.fitBounds(C)):1==u.length&&(l.setCenter(u[0].position),K=l.getZoom(),F=l.getCenter())}function v(a){var b=a.address;a.address="Lat/Long: "+b.lat().toFixed(6)+", "+b.lng().toFixed(6);w(b,a);B()}function x(a,b,d){b==google.maps.GeocoderStatus.OK?(w(a[0].geometry.location,d),G=setTimeout(function(){B()},330)):b==google.maps.GeocoderStatus.OVER_QUERY_LIMIT?(q(),A.push(d),G=setTimeout(function(){B()},
3E3)):b==google.maps.GeocoderStatus.ZERO_RESULTS&&(h.warn("Got ZERO results for ["+d.address+"]. Have left "+u.length+" items to process"),H.push(d.address),G=setTimeout(function(){B()},400))}function w(d,c){var i=new google.maps.Marker({position:d,title:c.address.replace("<br />"," :: "),content:c.address,zIndex:c.zIndex+1E3,map:l});if(i){if(c.markerIcon){var f=c.markerIcon;if("undefined"==typeof f||"undefined"===f)f="1-default.png";i.setIcon(J+f);var g=null,g=["4-default.png","5-default.png","6-default.png",
"7-default.png"],g=-1!=a.inArray(f,["1-default.png","2-default.png"])?L("http://maps.google.com/mapfiles/ms/icons/msmarker.shadow.png",59,32,0,0,16,33):-1!=a.inArray(f,g)?L("http://maps.google.com/mapfiles/ms/icons/msmarker.shadow.png",59,32,0,0,21,34):-1!=f.indexOf("3-default")?L("http://code.google.com/apis/maps/documentation/javascript/examples/images/beachflag_shadow.png",37,32,0,0,10,33):L(J+"shadow.png",68,37,0,0,32,38);i.setShadow(g)}b(i,c);M||(V(),M=!0);u.push(i)}}function L(a,b,d,c,g,h,o){return new google.maps.MarkerImage(a,
new google.maps.Size(b,d),new google.maps.Point(c,g),new google.maps.Point(h,o))}var u,A,H,N,G,M,l,D,P,r,F,K,s,S,C,t,Q,z,R;return{init:function(a,b){l=a;s=l.getDiv().id;P=b;google.maps.event.addListener(l,"click",function(){o()});u=[];H=[];A=[];K=5;r=F=D=G=null;N=M=!1;S=new google.maps.Geocoder;C=new google.maps.LatLngBounds;t=new google.maps.InfoWindow;Q=new google.maps.StreetViewService;R=new google.maps.DirectionsService;rendererOptions={draggable:!0};z=new google.maps.DirectionsRenderer(rendererOptions);
z.setPanel(document.getElementById("rendered-directions-placeholder-"+s))},buildAddressMarkers:function(a,b,d){N=!0;D=m.trim(a);D=m.searchReplace(D,"'","");if("true"===b)a=y(D),"true"===d?O(a,!0):"false"===d&&O(a,!1),B();else if(null==b||"false"===b){d=D.split("|");h.info("Exploded CSV into locations: "+d);for(a=0;a<d.length;a++){var c=d[a];null!=c&&""!=c&&(c=m.trim(c),""==c?h.warn("Given extra marker address is empty"):(b=a+1,c=c.split(I),m.isNumeric(c[0])?p(b,c,"","","",!1):m.isAlphaNumeric(c[0])?
n(b,c,"","","",!1):(n(b,c,"","","",!1),h.warn("Unknown type of geo destination in regexp: "+c[0]+", fallingback to store it as an address"))))}B()}},isBuildAddressMarkersCalled:function(){return N}}},m=function(){return{isNumeric:function(a){return/^([0-9?(\-.,;\s{1,})]+)$/.test(a)},isAlphaNumeric:function(a){return/^([a-zA-Z0-9?(/\-.,\s{1,})]+)$/.test(a)},trim:function(a){return a.replace(/^\s+|\s+$/g,"")},searchReplace:function(a,d,b){return a.replace(RegExp(d,"g"),b)}}}(),h=function(){var c=function(d){a.browser.msie||
(a.browser.mozilla&&1<=parseInt(a.browser.version)?console.log(d):a.browser.webkit&&534<=parseInt(a.browser.version)?console.log(d):a.browser.opera&&11<=parseInt(a.browser.version)&&console.log(d))};return{info:function(a){c("Info :: "+a)},raw:function(a){c(a)},warn:function(a){c("Warning :: "+a)},error:function(a){c("Error :: "+a)},fatal:function(a){c("Fatal :: "+a)}}}(),E=function(){return{alertError:function(c){function d(b,c){b.preventDefault();var d=a(c).closest("div.cgmp-popup-shortcode-dialog");
d&&a(d).remove();0==a("div.cgmp-popup-shortcode-dialog").length&&a("#cgmp-popup-mask").remove()}var b=a('<div id="cgmp-popup-mask"/>'),h=Math.random().toString(36).substring(3),g=a('<div id="'+h+'" class="cgmp-popup-shortcode-dialog cgmp-popup-window">');g.html("<div class='dismiss-container'><a class='dialog-dismiss' href='javascript:void(0)'>\u00d7</a></div><p style='text-align: left; padding: 10px 10px 0 10px'>"+c+"</p><div align='center'><input type='button' class='close-dialog' value='Close' /></div>");
a("body").append(b);a("body").append(g);c=a(document).height();b=a(window).width();a("#cgmp-popup-mask").css({width:b,height:c,opacity:0.1});1==a("#cgmp-popup-mask").length&&a("#cgmp-popup-mask").show();c=a(window).height();b=a(window).width();a("div#"+h).css("top",c/2-a("div#"+h).height()/2);a("div#"+h).css("left",b/2-a("div#"+h).width()/2);a("div#"+h).fadeIn(500);a(".cgmp-popup-window .close-dialog").click(function(b){d(b,a(this))});a(".cgmp-popup-window .dialog-dismiss").click(function(b){d(b,
a(this))});a("#cgmp-popup-mask").click(function(){a(this).remove();a(".cgmp-popup-window").remove()});a(window).resize(function(){var b=a(".window"),c=a(document).height(),d=a(window).width();a("#cgmp-popup-mask").css({width:d,height:c});c=a(window).height();d=a(window).width();b.css("top",c/2-b.height()/2);b.css("left",d/2-b.width()/2)})}}}();if(0==a("object#global-data-placeholder").length)h.fatal("The global HTML <object> element is undefined. Aborting map generation .. d[-_-]b");else{p=document.head||
document.getElementsByTagName("head")[0]||document.documentElement;var v=document.createElement("link");v.type="text/css";v.rel="stylesheet";v.href=a("object#global-data-placeholder").find("param#cssHref").val();v.media="screen";p.appendChild(v);I=a("object#global-data-placeholder").find("param#sep").val();J=a("object#global-data-placeholder").find("param#customMarkersUri").val();k=a("object#global-data-placeholder").find("param#errors").val();k=y(k);c=a("object#global-data-placeholder").find("param#translations").val();
c=y(c);if("undefined"==typeof google||!google)return E.alertError(k.msgNoGoogle),h.fatal("We do not have reference to Google API. Aborting map generation .."),!1;if("undefined"!=typeof GMap2&&GMap2)return E.alertError(k.msgApiV2),h.fatal("It looks like the webpage has reference to GMap2 object from Google API v2. Aborting map generation .."),!1;p=a("object#global-data-placeholder").find("param#language").val();google.load("maps","3",{other_params:"sensor=false&libraries=panoramio&language="+p,callback:function(){x()}})}})("undefined"===
typeof c||null==c||!c?jQuery:c)}if("undefined"===typeof jQuery||null==jQuery){var w=!1,x=document.head||document.getElementsByTagName("head")[0]||document.documentElement,c=document.createElement("script");c.type="text/javascript";c.src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js";c.onload=c.onreadystatechange=function(){if(!w&&(!this.readyState||/loaded|complete/.test(c.readyState))){w=!0;var T=jQuery.noConflict();n(T);c.onload=c.onreadystatechange=null;x&&c.parentNode&&x.removeChild(c);
c=void 0}};x.appendChild(c)}else n()})();
